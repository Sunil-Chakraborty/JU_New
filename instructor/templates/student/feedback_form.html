{% extends "base.html" %}

{% block content %}
	<style>
	/* ===== Google Forms–like styling ===== */
	.gf-container {
		max-width: 760px;
		margin: 40px auto;
		font-family: "Roboto", system-ui, sans-serif;
	}

	.gf-card {
		background: #fff;
		border-radius: 12px;
		padding: 32px;
		box-shadow: 0 4px 14px rgba(0,0,0,.08);
	}

	.gf-title {
		font-size: 28px;
		font-weight: 500;
		color: #202124;
		margin-bottom: 8px;
	}

	.gf-subtitle {
		font-size: 14px;
		color: #5f6368;
		margin-bottom: 28px;
	}

	.gf-question {
		margin-bottom: 28px;
	}

	.gf-question-title {
		font-size: 15px;
		font-weight: 500;
		color: #202124;
		margin-bottom: 10px;
	}

	.gf-option {
		display: block;
		margin-bottom: 8px;
		font-size: 14px;
		color: #202124;
	}

	.gf-option input {
		margin-right: 8px;
	}

	.gf-text,
	.gf-textarea {
		width: 100%;
		padding: 10px 12px;
		border: 1px solid #dadce0;
		border-radius: 6px;
		font-size: 14px;
	}

	.gf-textarea {
		min-height: 90px;
		resize: vertical;
	}

	.gf-rating label {
		display: inline-flex;
		align-items: center;
		margin-right: 12px;
		cursor: pointer;
		font-size: 16px;
		color: #fbbc04;
	}

	.gf-submit {
		margin-top: 32px;
		background: #1a73e8;
		color: #fff;
		border: none;
		padding: 10px 26px;
		font-size: 14px;
		font-weight: 500;
		border-radius: 6px;
		cursor: pointer;
	}

	.gf-submit:hover {
		background: #1558b0;
	}
	
	.gf-secondary-text {
		font-size: 13px;
		color: #5f6368;   /* Google gray */
		margin-top: 4px;
	}
	.gf-secondary-text.byline {
		font-style: italic;
	}
		
	
	.gf-rating {
		display: flex;
		flex-direction: column;
		gap: 8px;
		margin-top: 6px;
	}

	.rating-row {
		display: flex;
		align-items: center;
		gap: 10px;
		cursor: pointer;
	}

	.rating-row input {
		accent-color: #fbbc04;
		cursor: pointer;
	}

	.stars {
		font-size: 20px;
		letter-spacing: 3px;
	}

	.filled {
		color: #fbbc04;
	}

	.empty {
		color: #dadce0;
	}


	.rating-row:hover .stars { opacity: 0.8; }
	.rating-row input:checked + .stars { font-weight: bold; }


	</style>

<div class="gf-container">
    <div class="gf-card">

        
		
		<div class="gf-title">
			{{ session.title }}
			<span class="gf-secondary-text">
				· {{ session.created_at|date:"d M Y, h:i A" }}
			</span>
		</div>
		
        <div class="gf-subtitle">
            Your feedback is completely anonymous.
        </div>
		
		<!-- Attendance Section -->
		
		<div id="attendanceBox" style="margin-bottom:20px;">
			<button type="button" id="presentBtn" class="gf-submit" style="background:#34a853">
				I am Present
			</button>

			<div id="waitingBox" class="gf-secondary-text byline" style="display:none; margin-top:10px;">
				Waiting for teacher to allow feedback...
			</div>
		</div>


        <form method="post">
            {% csrf_token %}

            {% for q in questions %}
                <div class="gf-question">
                    <div class="gf-question-title">
                        {{ forloop.counter }}. {{ q.text }}
                    </div>

                    {# ===== SHORT TEXT ===== #}
                    {% if q.q_type == "text" %}
                        <input class="gf-text"
                               type="text"
                               name="question_{{ q.id }}">

                    {# ===== LONG TEXT ===== #}
                    {% elif q.q_type == "textarea" %}
                        <textarea class="gf-textarea"
                                  name="question_{{ q.id }}"></textarea>

                    {# ===== RADIO ===== #}
                    {% elif q.q_type == "radio" %}
                        {% for opt in q.options.all %}
                            <label class="gf-option">
                                <input type="radio"
                                       name="question_{{ q.id }}"
                                       value="{{ opt.id }}">
                                {{ opt.text }}
                            </label>
                        {% endfor %}

                    {# ===== CHECKBOX ===== #}
                    {% elif q.q_type == "checkbox" %}
                        {% for opt in q.options.all %}
                            <label class="gf-option">
                                <input type="checkbox"
                                       name="question_{{ q.id }}"
                                       value="{{ opt.id }}">
                                {{ opt.text }}
                            </label>
                        {% endfor %}

                    {# ===== YES / NO ===== #}
                    {% elif q.q_type == "yes_no" %}
                        {% for opt in q.options.all %}
                            <label class="gf-option">
                                <input type="radio"
                                       name="question_{{ q.id }}"
                                       value="{{ opt.id }}">
                                {{ opt.text }}
                            </label>
                        {% endfor %}

						{# ===== RATING ===== #}
						{% elif q.q_type == "rating" %}
						<div class="gf-rating">

							{% for rating in "12345" %}
							{% with r=forloop.counter %}
								<label class="rating-row">
									<input type="radio"
										   name="question_{{ q.id }}"
										   value="{{ r }}">

									<span class="stars">
										{% for star in "12345" %}
											{% if forloop.counter <= r %}
												<span class="filled">★</span>
											{% else %}
												<span class="empty">★</span>
											{% endif %}
										{% endfor %}
									</span>
								</label>
							{% endwith %}
							{% endfor %}

						</div>
						{% endif %}


                </div>
            {% endfor %}

            <button type="submit" id="submitBtn" class="gf-submit" style="display:none;">
				Submit Feedback
			</button>

        </form>

    </div>
</div>

		<script>
		const token = "{{ session.public_token }}";
		let markedPresent = false;

		// --------------------
		// Mark Attendance
		// --------------------
		document.getElementById("presentBtn").onclick = function() {

			if(markedPresent) return;

			fetch(`/instructor/feedback/${token}/attendance/`)
			.then(res => res.json())
			.then(data => {

				markedPresent = true;

				document.getElementById("presentBtn").style.display = "none";
				document.getElementById("waitingBox").style.display = "block";

				// remember locally (avoid duplicate click after refresh)
				localStorage.setItem("present_"+token, "1");
			});
		};


		// restore state if refreshed
		if(localStorage.getItem("present_"+token)){
			markedPresent = true;
			document.getElementById("presentBtn").style.display = "none";
			document.getElementById("waitingBox").style.display = "block";
		}


		// --------------------
		// Poll teacher approval
		// --------------------
		function checkPermission(){

			fetch(`/instructor/feedback/${token}/status/`)
			.then(res => res.json())
			.then(data => {

				if(data.open && markedPresent){
					document.getElementById("submitBtn").style.display = "inline-block";
					document.getElementById("waitingBox").innerText =
						"Feedback open. Please submit now.";
				}
			});
		}

		// check every 5 sec
		setInterval(checkPermission, 5000);
		checkPermission();
		</script>

{% endblock %}
