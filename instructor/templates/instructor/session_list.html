{% extends "base.html" %}
{% block content %}

<style>
    .wrapper {
        max-width: 900px;
        margin: 40px auto;
    }

    .header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
    }

    h2 {
        margin: 0;
        color: #202124;
    }

    .create-btn {
        background: #1a73e8;
        color: #fff;
        padding: 10px 16px;
        border-radius: 6px;
        text-decoration: none;
        font-size: 14px;
    }

    .card {
        background: #fff;
        padding: 18px 22px;
        border-radius: 8px;
        box-shadow: 0 2px 6px rgba(0,0,0,.12);
        margin-bottom: 15px;
    }

    .title {
        font-weight: 600;
        font-size: 16px;
        margin-bottom: 8px;
    }

    .actions a {
        margin-right: 15px;
        text-decoration: none;
        font-size: 14px;
        color: #1a73e8;
    }

    .actions a.student {
        color: #0f9d58;
    }

    .empty {
        background: #f8f9fa;
        padding: 20px;
        border-radius: 6px;
        color: #666;
    }
	.actions a.qr {
		color: #1a73e8;
		font-weight: 500;
	}
	
	.session-meta {
		display: flex;
		justify-content: space-between;
		margin-top: 6px;
		font-size: 14px;
		color: #555;
	}

	.session-count {
		background: #eef6ff;
		color: #0b5ed7;
		padding: 4px 10px;
		border-radius: 20px;
		font-weight: 600;
		font-size: 13px;
	}

	.session-count::before {
		content: "ğŸ“Š ";
	}

	.control-btn{
		margin-left:12px;
		padding:5px 12px;
		border-radius:20px;
		font-size:13px;
		text-decoration:none;
		font-weight:600;
		border:1px solid transparent;
	}

	.open-btn{
		background:#e6f4ea;
		color:#137333;
		border-color:#34a853;
	}

	.close-btn{
		background:#fce8e6;
		color:#c5221f;
		border-color:#ea4335;
	}	

	.control-btn:hover{
		opacity:.85;
	}

</style>

<div class="wrapper">

    <div class="header">
	
			<a href="{% url 'instructor:dashboard' %}" class="back-link">
				â† Back to Dashboard
			</a>
			
        <h2>Your Feedback Sessions</h2>

        <a href="{% url 'instructor:create_feedback_session' %}" class="create-btn">
            + New Session
        </a>
    </div>

    {% for s in sessions %}
        <div class="card">
		
			
            <div class="session-title">
				{{ s.title }}
				
				<span class="session-meta">
					Â· {{ s.created_at|date:"d M Y, h:i A" }}
				</span>
				
				<span class="response-count" id="count-{{ s.id }}">
					ğŸ‘¥ {{ s.response_count }} Responses
				</span>


			</div>
			
			<div class="session-live" style="margin-top:8px; font-size:14px;">

				<span id="present-{{ s.id }}">
					ğŸ‘¥ 0 Present
				</span>

				&nbsp;|&nbsp;

				<span id="status-{{ s.id }}">
					{% if s.feedback_open %}
						ğŸŸ¢ Feedback Open
					{% else %}
						ğŸ”´ Closed
					{% endif %}
				</span>

				{% if s.feedback_open %}
					<a href="{% url 'instructor:toggle_feedback' s.id %}"
					   class="control-btn close-btn">
					   â›” Close
					</a>
				{% else %}
					<a href="{% url 'instructor:toggle_feedback' s.id %}"
					   class="control-btn open-btn">
					   â–¶ Start
					</a>
				{% endif %}

			</div>




            <div class="actions">
                <a href="{% url 'instructor:create_question' s.id %}">
                    âœ Add / Edit Questions
                </a>

                <a href="{% url 'instructor:student_feedback' s.id %}"
                   class="student"
                   target="_blank">
                    ğŸ”— Student Link
                </a>
				
				<a href="{% url 'instructor:generate_qr' s.id %}"
				   style="color:#1a73e8;"
				   target="_blank">
					ğŸ“± Show QR
				</a>
				
				{% if not s.questions.exists %}
					<a href="{% url 'instructor:delete_session' s.id %}"
					   style="color:#e53935;"
					   onclick="return confirm(
						   'Delete this feedback session? This cannot be undone.'
					   );">
						ğŸ—‘ Delete
					</a>
				{% endif %}
				
				
            </div>
        </div>
    {% empty %}
        <div class="empty">
            No feedback sessions created yet.
        </div>
    {% endfor %}

</div>
	<script>
		function updateLiveAttendance(){

			fetch("{% url 'instructor:live_attendance_counts' %}")
			.then(res => res.json())
			.then(data => {

				for(const id in data){

					// update present count
					const presentEl = document.getElementById("present-"+id);
					if(presentEl){
						presentEl.innerText = "ğŸ‘¥ " + data[id].present + " Present";
					}

					// update open/close status
					const statusEl = document.getElementById("status-"+id);
					if(statusEl){
						statusEl.innerText = data[id].open ? "ğŸŸ¢ Feedback Open" : "ğŸ”´ Closed";
					}
				}
			});
		}

		// every 5 sec
		setInterval(updateLiveAttendance, 5000);
		updateLiveAttendance();
	</script>

	<script>
	function updateResponseCounts(){

		fetch("{% url 'instructor:live_response_counts' %}")
		.then(res => res.json())
		.then(data => {

			for(const id in data){

				const el = document.getElementById("count-"+id);
				if(el){
					el.innerText = "ğŸ‘¥ " + data[id].responses + " Responses";
				}
			}
		});
	}

	// run every 5 seconds
	setInterval(updateResponseCounts, 5000);
	updateResponseCounts();
	</script>

{% endblock %}
